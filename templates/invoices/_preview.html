<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ invoice.client.company_name }} Invoice ({{ invoice.client.client_name }})</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="{% static 'images/favicon.png' %}">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
        }
        .invoice-container {
            max-width: 800px;
            margin: 30px auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .invoice-header {
            padding: 30px;
            padding-bottom: 10px;
            border-bottom: 1px solid #d6d6d6;
        }
        .invoice-title {
            font-size: 40px;
            font-weight: bold;
            margin: 0;
        }
        .invoice-meta {
            text-align: right;
            font-size: 13px;
        }
        .invoice-meta strong{
            color: #666;
        }
        .invoice-info {
            font-weight: bold;
            color: #666;
        }
        .company-info {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-top: 20px;
        }
        .logo-icon {
            width:35px; 
        }
        .company-details div {
            color: #333;
            font-size: 14px;
        }
        .company-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .billed-section {
            padding: 30px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .info-block h6 {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
        }
        .info-block div {
            margin: 3px 0;
            color: #333;
            font-size: 14px;
        }
        .table-container {
            padding: 0 30px;
        }
        .invoice-table {
            margin-bottom: 0;
        }
        .invoice-table thead {
            background-color: #f8f9fa;
            border-top: 2px solid #dee2e6;
            border-bottom: 2px solid #dee2e6;
        }
        .invoice-table thead th {
            font-weight:600;
            font-size: 11px;
            text-transform: uppercase;
            padding: 15px;
            color: #333;
        }
        .invoice-table tbody td {
            padding: 15px;
            font-size: 13px;
            vertical-align: middle;
            border-bottom: 1px solid #dee2e6;
        }
        .invoice-table tbody tr:last-child td {
            border-bottom: 2px solid #dee2e6;
        }
        .footer-section {
            padding: 30px;
        }
        .payment-note {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        .contact-note {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }
        .totals-section {
            text-align: right;
            margin-top: 20px;
        }
        .total-row {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 10px;
            font-size: 15px;
        }
        .total-label {
            margin-right: 50px;
            color: #666;
            font-weight: 400;
            font-size: 13px;
        }
        .total-amount {
            width: 100px;
            text-align: right;
            font-weight: 500;
        }
        .amount-due-row {
            background: linear-gradient(135deg, #00adfc 0%, #0054fd 70%);
            color: white;
            padding: 15px 30px;
            margin: 0 -30px;
            display: flex;
            /* justify-content: flex-end; */
            align-items: center;
            margin-top: 10px;
        }
        .amount-due-label {
            font-size: 18px;
            font-weight: bold;
            margin-right: 50px;
        }
        .amount-due-value {
            font-size: 24px;
            font-weight: bold;
            width: 100px;
            text-align: right;
        }

        .bank-details{
            font-size: 14px;
            color: #676767;
        } 
        .bank-details p{
            margin: 2px 0;
        }

        @media print {
            body {
                background: white;
            }
            .invoice-container {
                box-shadow: none;
                margin: 0;
            }
        }
    </style>
</head>
<body>
    {% load mathfilters %}
    <div class="invoice-container">
        <!-- Header -->
        <div class="invoice-header">
            <div class="d-flex justify-content-between align-items-start">
                <h1 class="invoice-title"><img src="{{company.logo.url}}" alt="Company Logo" class="logo-icon">
                    INVOICE</h1>
                <div class="invoice-meta">
                    <div><strong>INVOICE NO: </strong>{{ invoice.invoice_number }}</div>
                    <div><strong>INVOICE DATE: </strong>{{ invoice.invoice_date }}</div>
                    <div><strong>DUE DATE: </strong>{{ invoice.due_date }}</div>
                </div>
            </div>
        </div>

        <!-- Company & Billing Info -->
        <div class="billed-section">
            <div class="info-row">
                <div class="info-block">
                    <div class="company-info">
                        <div>
                            <div class="company-name">{{ company.name }}</div>
                            <div class="company-details">
                                <div>Address:
                                    <pre
                                        style="font-size: 14px;display: inline; word-spacing: 0px;white-space: pre-line;font-family: inherit;padding: 0px;margin: 0px;"> {{ company.address }}</pre>
                                </div>
                                <div>Phone: {{ company.phone }}</div>
                                <div>Email: {{ company.email }}</div>
                                <div>Website: {{ company.website }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="info-block">
                    <h6>Billed To</h6>
                    <div>{{ invoice.client.company_name }}</div>
                    <div>Name: {{ invoice.client.client_name }}</div>
                    <div>( {{ invoice.client.client_profession }})</div>
                    <div>Address:
                        <pre
                            style="font-size: 14px; display: inline; word-spacing: 0px;white-space: pre-line;font-family: inherit;padding: 0px;margin: 0px;"> {{ invoice.client.address }}</pre>
                    </div>
                    <div>Phone: {{ invoice.client.phone }}</div>
                    <div>Email: {{ invoice.client.email }}</div>
                </div>
            </div>
        </div>

        <!-- Invoice Items Table -->
        <div class="table-container">
            <table class="table invoice-table">
                <thead>
                    <tr>
                        <th style="width: 10%;">ITEM NO.</th>
                        <th style="width: 40%;">PRODUCT/SERVICE</th>
                        <th style="width: 15%;">QUANTITY</th>
                        <th style="width: 17%;">UNIT PRICE</th>
                        <th style="width: 17%;">Tax</th>
                        <th style="width: 17%;">Discount</th>
                        <th style="width: 18%;" class="text-end">TOTAL</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in invoice.items.all %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ item.description }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>{{ item.unit_price }}</td>
                        <td>{{ item.tax_rate }}%</td>
                        <td>{{ item.discount }}</td>
                        <td>{{ item.total }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Footer with Totals -->
        <div class="footer-section mb-0 pb-0">
            <div class="row">
                <div class="col-md-8">
                    <p class="payment-note"><strong>{{invoice.internal_notes}}</strong></p>
                    <p class="contact-note">
                        If you have any questions about this invoice<br>
                        please contact us using the below details.<br>
                        {{ company.phone }} | {{ company.email }}
                    </p>
                    <p class="contact-note w-75">
                        {{invoice.notes}}
                    </p>
                    <div class="bank-details">
                        <h6 class="">Bank Details</h6>
                        <div class="row">
                            <div class="col">
                                <p>Bank: {{company.bank_name}}</p>
                            </div>
                            <div class="col">
                                <p>Name: {{company.account_name}}</p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <p>Acc. No: {{company.account_number}}</p>
                            </div>
                            <div class="col">
                                <p>UPI: {{company.upi_id}}</p>
                            </div>
                        </div>
                        <div class="row">
                        </div>
                        <div class="row">
                            <div class="col">
                                <p>IFSC: {{company.ifsc_code}}</p>
                            </div>

                            <div class="col">
                                <p>PayPal: {{company.paypal_id}}</p>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="col-md-4">
                    <div class="totals-section">
                        <div class="total-row">
                            <span class="total-label">SUBTOTAL</span>
                            <span class="total-amount">{{ invoice.subtotal }}</span>
                        </div>
                        <div class="total-row">
                            <span class="total-label">DISCOUNT </span>
                            <span class="total-amount">{{ invoice.discount }}</span>
                        </div>
                        <div class="total-row">
                            <span class="total-label">Additional Charges</span>
                            <span class="total-amount">{{ invoice.additional_charges }}</span>
                        </div>
                        <div class="total-row">
                            <span class="total-label">TAX({{ invoice.tax }}%) </span>
                            <span class="total-amount">
                                {% with subtotal_after_discount=invoice.subtotal|add:invoice.additional_charges|sub:invoice.discount %}
                                {{ subtotal_after_discount|mul:invoice.tax|div:100 }}
                                {% endwith %}
                            </span>
                        </div>
                        <div class="total-row">
                            <span class="total-label">Total </span>
                            <span class="total-amount">{{ invoice.total }}</span>
                        </div>
                        <div class="total-row">
                            <span class="total-label">Paid Amount</span>
                            <span class="total-amount">{{ invoice.amount_paid }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex amount-due-row">
                <div class="me-auto">
                    <a type="button" role="button" class="btn btn-outline-light disabled paynow-btn d-none">
                        Pay Now &rarr;
                        <span>Comming Soon...</span>
                    </a>
                </div>
                <div>
                    <span class="amount-due-label">AMOUNT DUE</span>
                    <span class="amount-due-value">{{ invoice.balance_due }}</span>
                </div>
            </div>
        </div>
        <p class="contact-note p-2">{{invoice.public_message}}</p>
    </div>
    
    <!-- Action Buttons -->
    <div class="fixed-bottom mb-3 me-3 d-flex justify-content-end action-buttons">
        <button onclick="downloadInvoice()" class="btn btn-primary me-2">Download</button>
        <button onclick="printInvoice()" class="btn btn-primary me-2">Print</button>
        <button id="shareBtn" class="shareBtn btn btn-success me-2" type="button">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            <span class="sharing-text">Share</span>
        </button>
        <a href="{% url 'create_invoice' %}" class="btn btn-secondary">Close</a>
    </div>

    <!-- ================= RESET CONFIRMATION ================= -->
    <div class="modal fade" id="resetModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow">
            <div class="modal-body text-center py-4">
                <p class="fw-semibold mb-3">Invoice shared successfully!</p>
                <div class="alert alert-success text-start mb-4">
                    <h5 class="mb-3"><i class="bi bi-check-circle-fill text-success"></i> Invoice Shared Successfully!</h5>
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Client Company</dt>
                        <dd class="col-sm-8">{{ invoice.client.company_name }}</dd>

                        <dt class="col-sm-4">Client Name</dt>
                        <dd class="col-sm-8">{{ invoice.client.client_name }}</dd>

                        <dt class="col-sm-4">Profession</dt>
                        <dd class="col-sm-8">{{ invoice.client.client_profession }}</dd>

                        <dt class="col-sm-4">Email</dt>
                        <dd class="col-sm-8">{{ invoice.client.email }}</dd>

                        <dt class="col-sm-4">Phone</dt>
                        <dd class="col-sm-8">{{ invoice.client.phone }}</dd>

                        <dt class="col-sm-4">Invoice Number</dt>
                        <dd class="col-sm-8">{{ invoice.invoice_number }}</dd>

                        <dt class="col-sm-4">Invoice Date</dt>
                        <dd class="col-sm-8">{{ invoice.invoice_date }}</dd>

                        <dt class="col-sm-4">Amount Due</dt>
                        <dd class="col-sm-8">{{ invoice.balance_due }}</dd>

                        <dt class="col-sm-4">Access Link</dt>
                        <dd class="col-sm-8">
                            <a href="/api/invoices/{{ invoice.invoice_number }}/preview/shared/" target="_blank" class="text-primary text-break">
                                {{ invoice.invoice_number }}/preview/shared/
                            </a>
                        </dd>
                        <p class="m-0 p-0 mt-2">Client must verify the OTP sent to their email to access the invoice.</p>
                    </dl>
                </div>
                <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
            </div>
        </div>
    </div>
  
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>


    <script>
        (function () {
            const btn = document.querySelector(".shareBtn");
            if (!btn) return; // nothing to do if button is missing

            btn.addEventListener("click", async (e) => {
                // prefer the button element itself (in case event properties change after await)
                const button = e.currentTarget || e.target.closest('.shareBtn') || btn;
                if (!button) return;

                e.preventDefault();

                const textEl = button.querySelector(".sharing-text");
                const spinner = button.querySelector(".spinner-border");

                // Update UI safely
                if (textEl) textEl.innerText = " Sharing...";
                if (spinner) spinner.classList.remove("d-none");
                button.classList.add("disabled");

                // Simulate a delay for demonstration purposes
                await new Promise(resolve => setTimeout(resolve, 2000));

                try {
                    const response = await fetch(`/api/invoices/{{ invoice.invoice_number }}/share/`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            "csrf_token": "{{ csrf_token }}",
                        })
                    });

                    let data = {};
                    try {
                        data = await response.json();
                        console.log("Response data:", data);
                        new bootstrap.Modal(document.getElementById("resetModal")).show();

                    } catch (parseErr) {
                        console.error('Failed to parse JSON response', parseErr);
                    }

                    if (data && data.success) {
                        console.log(data.message || 'Invoice shared');
                    } else {
                        console.log('Failed to share the invoice.');
                    }
                } catch (error) {
                    console.error("Error:", error);
                } finally {
                    // restore UI safely
                    if (spinner) spinner.classList.add("d-none");
                    if (textEl) textEl.innerText = "Share";
                    button.classList.remove("disabled");
                }
            });
        })();

        function printInvoice() {
            const originalTitle = document.title;
            document.querySelector('.action-buttons').classList.add('d-none')
            document.title = '.';
            window.print();
            document.title = originalTitle;
            document.querySelector('.action-buttons').classList.remove('d-none')

        }
        
       function downloadInvoice() {
            let element = document.querySelector(".invoice-container");
            html2pdf().from(element).save(document.title);
        }
        
    </script>
</body>
</html>